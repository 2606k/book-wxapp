# 登录流程完整说明

## 功能概述

本项目实现了完整的微信小程序登录流程，使用微信官方的 `getUserProfile` 方法获取用户头像和昵称，通过后端接口获取 openid，并将用户信息保存到后端数据库。

## 登录流程图

```
用户触发登录
    ↓
跳转到登录页面
    ↓
用户点击"获取头像和昵称"
    ↓
调用 wx.getUserProfile()
    ↓
微信弹出授权弹窗
    ↓
用户同意授权
    ↓
获取用户头像和昵称
    ↓
显示用户信息预览
    ↓
用户点击"登录"按钮
    ↓
获取微信登录 code (wx.login)
    ↓
调用后端 admin/getOpenId 获取 openid
    ↓
调用后端 admin/register 保存用户信息
    ↓
保存到本地缓存和全局变量
    ↓
登录成功，返回上一页
    ↓
执行原操作（如加入购物车）
```

## 技术实现

### 1. 登录页面 (pages/login/index)

#### 页面功能
- ✅ 使用微信官方 `getUserProfile` 获取用户信息
- ✅ 显示用户头像和昵称预览
- ✅ 支持重新获取用户信息
- ✅ 点击"登录"按钮完成登录流程
- ✅ 支持取消登录返回上一页
- ✅ 美观的渐变背景设计

#### 核心方法

**获取用户信息**
```javascript
getUserProfile() {
  wx.getUserProfile({
    desc: '用于完善用户资料',
    success: (res) => {
      console.log('获取用户信息成功:', res.userInfo)
      this.setData({
        userInfo: res.userInfo,
        hasUserInfo: true
      })
    },
    fail: (err) => {
      console.error('获取用户信息失败:', err)
    }
  })
}
```

**登录流程**
```javascript
async handleLogin() {
  const app = getApp()
  
  // 1. 获取微信登录 code
  const code = await app.getWxLoginCode()
  
  // 2. 调用后端获取 openid
  const openid = await app.getOpenIdFromBackend(code)
  
  // 3. 组合完整用户信息
  const completeUserInfo = {
    ...this.data.userInfo,
    openid: openid
  }
  
  // 4. 保存到后端
  const savedUserInfo = await app.saveUserToBackend(completeUserInfo)
  
  // 5. 执行成功回调
  app.globalData.loginSuccessCallback(savedUserInfo)
  
  // 6. 返回上一页
  wx.navigateBack()
}
```

### 2. App.js 登录相关方法

#### getUserProfile()
获取用户基本信息（头像、昵称）

```javascript
getUserProfile() {
  return new Promise((resolve, reject) => {
    wx.getUserProfile({
      desc: '用于完善用户资料',
      success: (res) => {
        resolve(res.userInfo)
      },
      fail: (error) => {
        // 如果失败，返回默认信息
        resolve({
          nickName: '微信用户',
          avatarUrl: ''
        })
      }
    })
  })
}
```

#### getWxLoginCode()
获取微信登录 code

```javascript
getWxLoginCode() {
  return new Promise((resolve, reject) => {
    wx.login({
      success: (res) => {
        if (res.code) {
          resolve(res.code)
        } else {
          reject(new Error('获取code失败'))
        }
      },
      fail: (error) => {
        reject(error)
      }
    })
  })
}
```

#### getOpenIdFromBackend(code)
调用后端接口获取 openid

```javascript
getOpenIdFromBackend(code) {
  return new Promise((resolve, reject) => {
    wx.request({
      url: this.globalData.baseUrl + 'admin/getOpenId',
      method: 'POST',
      header: {
        'Content-Type': 'application/json'
      },
      data: {
        code: code
      },
      success: (result) => {
        if (result.data && result.data.code === 200) {
          const openid = result.data.data
          // 保存到本地和全局
          wx.setStorageSync('openid', openid)
          this.globalData.openid = openid
          resolve(openid)
        } else {
          reject(new Error('获取openid失败'))
        }
      },
      fail: (error) => {
        reject(error)
      }
    })
  })
}
```

#### saveUserToBackend(userInfo)
保存用户信息到后端

```javascript
saveUserToBackend(userInfo) {
  return new Promise((resolve, reject) => {
    const userData = {
      userName: userInfo.nickName,
      avatarUrl: userInfo.avatarUrl,
      openid: userInfo.openid
    }

    wx.request({
      url: this.globalData.baseUrl + 'admin/register',
      method: 'POST',
      data: userData,
      header: {
        'Content-Type': 'application/json'
      },
      success: (result) => {
        if (result.data && result.data.code === 200) {
          // 保存到本地和全局
          wx.setStorageSync('userInfo', userInfo)
          this.globalData.userInfo = userInfo
          
          // 通知监听器
          this.notifyLoginListeners(userInfo)
          resolve(userInfo)
        } else {
          reject(new Error('保存用户信息失败'))
        }
      },
      fail: (error) => {
        reject(error)
      }
    })
  })
}
```

#### showLoginDialog(successCallback, cancelCallback)
显示登录弹窗（跳转到登录页面）

```javascript
showLoginDialog(successCallback, cancelCallback) {
  // 保存回调函数到全局
  this.globalData.loginSuccessCallback = successCallback
  this.globalData.loginCancelCallback = cancelCallback
  
  // 跳转到登录页面
  wx.navigateTo({
    url: '/pages/login/index'
  })
}
```

#### checkLoginAndShow(successCallback, cancelCallback)
检查登录状态，未登录则显示登录页面

```javascript
checkLoginAndShow(successCallback, cancelCallback) {
  if (this.checkUserAuth()) {
    // 已登录，直接执行成功回调
    const userInfo = wx.getStorageSync('userInfo')
    if (successCallback) {
      successCallback(userInfo)
    }
    return true
  } else {
    // 未登录，显示登录页面
    this.showLoginDialog(successCallback, cancelCallback)
    return false
  }
}
```

## 后端接口

### 1. 获取 openid

**接口地址**
```
POST /admin/getOpenId
```

**请求参数**
```json
{
  "code": "微信登录code"
}
```

**响应格式**
```json
{
  "code": 200,
  "msg": "成功",
  "data": "openid字符串"
}
```

### 2. 注册/保存用户信息

**接口地址**
```
POST /admin/register
```

**请求参数**
```json
{
  "userName": "用户昵称",
  "avatarUrl": "用户头像URL",
  "openid": "用户openid"
}
```

**响应格式**
```json
{
  "code": 200,
  "msg": "成功",
  "data": {
    "userId": 用户ID
  }
}
```

## 页面使用示例

### 示例1：首页加入购物车

```javascript
// pages/home/index.js
async addToCart(e) {
  const book = e.currentTarget.dataset.book
  
  // 检查登录状态
  const app = getApp()
  if (!app.checkUserAuth()) {
    // 未登录，跳转到登录页面
    app.showLoginDialog(async () => {
      // 登录成功后执行加购操作
      await this.doAddToCart(book)
    })
    return
  }
  
  // 已登录，直接加购
  await this.doAddToCart(book)
}
```

### 示例2：购物车页面

```javascript
// pages/cart/index.js
onLoad(options) {
  const app = getApp()
  
  if (!app.checkUserAuth()) {
    // 未登录，显示登录页面
    app.showLoginDialog(() => {
      // 登录成功后加载购物车
      this.loadCartData()
    }, () => {
      // 取消登录，返回上一页
      wx.navigateBack()
    })
  } else {
    // 已登录，直接加载
    this.loadCartData()
  }
}
```

### 示例3：个人中心

```javascript
// pages/mine/index.js
handleLogin() {
  if (this.data.isLogin) {
    return
  }

  const app = getApp()
  app.showLoginDialog(() => {
    // 登录成功，刷新用户信息
    this.loadUserInfo()
  })
}
```

## 用户体验

### 登录页面特性

1. **美观的UI设计**
   - 渐变背景（紫色系）
   - 圆角卡片设计
   - 清晰的视觉层次

2. **清晰的操作流程**
   - 步骤1：点击"获取头像和昵称"
   - 步骤2：微信授权弹窗
   - 步骤3：显示用户信息预览
   - 步骤4：点击"登录"完成

3. **友好的交互反馈**
   - 加载状态提示
   - 成功/失败提示
   - 按钮禁用状态
   - 重新获取选项

4. **灵活的取消机制**
   - 可以随时取消登录
   - 取消后返回上一页
   - 不影响其他功能

### 页面截图说明

登录页面包含以下元素：
- 顶部：Logo + "欢迎登录" 标题
- 中部：用户信息预览卡片（获取信息后显示）
- 按钮区：
  - "获取头像和昵称" 按钮
  - "重新获取" 按钮（可选）
  - "登录" 按钮（高亮）
  - "取消" 按钮
- 底部：说明文字

## 数据存储

### 本地缓存
```javascript
// 用户信息
{
  nickName: '微信用户',
  avatarUrl: 'https://...',
  openid: 'xxxxxx',
  userId: 123456
}

// openid
'xxxxxxxxxxxxxx'
```

### 全局变量
```javascript
app.globalData = {
  userInfo: { ... },
  openid: 'xxxxxx',
  loginSuccessCallback: function() {},
  loginCancelCallback: function() {}
}
```

## 注意事项

### 1. getUserProfile 使用限制
- ⚠️ 必须由用户主动触发（如点击按钮）
- ⚠️ 不能在页面加载时自动调用
- ⚠️ 每次调用都会弹出授权弹窗
- ⚠️ 用户可以拒绝授权

### 2. 登录时机
- 建议在用户需要使用功能时再提示登录
- 不要在首页强制登录
- 提供清晰的登录入口（个人中心）

### 3. 错误处理
- 网络错误：本地容错，数据先保存本地
- 授权失败：提供重试机制
- 后端错误：显示友好提示

### 4. 安全性
- openid 敏感信息，注意保护
- 用户信息仅用于必要功能
- 遵守微信小程序规范

## 测试清单

### 功能测试
- [ ] 点击"获取头像和昵称"弹出授权弹窗
- [ ] 同意授权后显示用户信息预览
- [ ] 拒绝授权后提示失败
- [ ] 点击"重新获取"可以再次获取
- [ ] 点击"登录"成功完成登录
- [ ] 点击"取消"返回上一页
- [ ] 登录成功后执行回调操作

### 场景测试
- [ ] 未登录访问购物车 → 跳转登录页
- [ ] 未登录加入购物车 → 跳转登录页
- [ ] 个人中心点击头像 → 跳转登录页
- [ ] 登录成功后自动加购 → 成功
- [ ] 取消登录 → 返回原页面

### 异常测试
- [ ] 网络断开时登录 → 友好提示
- [ ] 后端接口错误 → 容错处理
- [ ] 连续快速点击 → 防重复提交

## 文件清单

### 新增/修改文件
1. ✅ `app.js` - 登录相关方法
2. ✅ `pages/login/index.js` - 登录页面逻辑
3. ✅ `pages/login/index.wxml` - 登录页面视图
4. ✅ `pages/login/index.wxss` - 登录页面样式
5. ✅ `pages/login/index.json` - 登录页面配置
6. ✅ `pages/mine/index.js` - 个人中心
7. ✅ `pages/cart/index.js` - 购物车
8. ✅ `pages/home/index.js` - 首页
9. ✅ `pages/categoryBrand/index.js` - 分类页

### 接口对接
- ✅ `POST /admin/getOpenId` - 获取openid
- ✅ `POST /admin/register` - 保存用户信息

## 更新日志

**2024-10-12**
- ✅ 创建独立的登录页面
- ✅ 使用微信官方 getUserProfile 方法
- ✅ 实现用户信息预览功能
- ✅ 对接后端 admin/getOpenId 接口
- ✅ 对接后端 admin/register 接口
- ✅ 优化用户体验和UI设计
- ✅ 完善错误处理和状态反馈

---

**创建时间**: 2024年10月12日  
**文档版本**: v2.0  
**更新说明**: 使用独立登录页面，采用微信官方 getUserProfile 方法

