# 登录功能 - 微信官方最新方式

## 概述

本项目使用微信小程序官方最新推荐的用户信息获取方式：
- **头像选择**：使用 `button` 组件的 `open-type="chooseAvatar"`
- **昵称填写**：使用 `input` 组件的 `type="nickname"`
- **表单提交**：使用 `form` 表单收集用户输入

## 为什么使用新方式？

### 旧方式的问题
之前的 `wx.getUserProfile` 方法：
- ❌ 每次调用都会弹窗，用户体验不好
- ❌ 可能被微信官方逐步废弃
- ❌ 无法自定义头像和昵称

### 新方式的优势
使用 `chooseAvatar` + `nickname` 方式：
- ✅ 更灵活，用户可以选择任意头像
- ✅ 符合微信官方最新规范
- ✅ 更好的用户体验
- ✅ 自动进行内容安全检测

## 技术实现

### 1. WXML 视图层

#### 头像选择器
```html
<button 
  class="avatar-picker" 
  open-type="chooseAvatar" 
  bindchooseavatar="onChooseAvatar">
  <image 
    class="avatar-image" 
    src="{{avatarUrl || '/assets/imgs/mine/morentouxiang.png'}}" 
    mode="aspectFill">
  </image>
  <view class="avatar-tip" wx:if="{{!avatarUrl}}">
    <text>点击选择头像</text>
  </view>
</button>
```

**关键点：**
- `open-type="chooseAvatar"` - 指定按钮为头像选择器
- `bindchooseavatar` - 绑定选择头像的回调事件
- 从基础库 2.24.4 起，如果头像未通过安全检测，不会触发回调

#### 昵称输入框
```html
<input 
  class="nickname-input" 
  type="nickname" 
  name="nickname"
  value="{{nickName}}"
  placeholder="请输入昵称"
  bindinput="onNicknameInput"
  bindblur="onNicknameBlur"
  maxlength="20"
/>
```

**关键点：**
- `type="nickname"` - 指定输入类型为昵称
- `name="nickname"` - 表单字段名
- `bindblur` - 失焦时微信会异步检测内容安全
- 从基础库 2.24.4 起，未通过安全检测的内容会被自动清空

#### 表单提交
```html
<form bindsubmit="handleLogin">
  <!-- 头像选择 -->
  <!-- 昵称输入 -->
  
  <button form-type="submit">登录</button>
</form>
```

**关键点：**
- 使用 `form` 包裹所有输入
- `form-type="submit"` - 提交表单
- 通过 `bindsubmit` 事件获取表单数据

### 2. JS 逻辑层

#### 选择头像回调
```javascript
onChooseAvatar(e) {
  console.log('选择头像:', e.detail.avatarUrl)
  const { avatarUrl } = e.detail
  
  this.setData({
    avatarUrl: avatarUrl
  })
  
  wx.showToast({
    title: '头像已选择',
    icon: 'success'
  })
}
```

**说明：**
- `e.detail.avatarUrl` 包含临时头像路径
- 临时路径需要上传到服务器保存
- 如果头像未通过安全检测，不会触发此回调

#### 昵称输入
```javascript
onNicknameInput(e) {
  this.setData({
    nickName: e.detail.value
  })
}
```

#### 昵称失焦（安全检测）
```javascript
onNicknameBlur(e) {
  console.log('昵称失焦:', e.detail.value)
  // 微信会自动进行内容安全检测
  // 如果检测不通过，微信会自动清空内容
}
```

**重要：**
- 失焦时微信会异步检测内容安全
- 检测不通过会自动清空 input 的值
- 建议通过 form 提交来收集最终数据

#### 表单提交（登录）
```javascript
async handleLogin(e) {
  // 从表单获取昵称（更安全）
  const formNickname = e.detail.value.nickname
  
  // 验证信息
  if (!this.data.avatarUrl) {
    wx.showToast({ title: '请选择头像', icon: 'none' })
    return
  }
  
  if (!formNickname || formNickname.trim() === '') {
    wx.showToast({ title: '请输入昵称', icon: 'none' })
    return
  }
  
  // 上传头像
  let uploadedAvatarUrl = this.data.avatarUrl
  if (this.data.avatarUrl.indexOf('tmp') !== -1) {
    uploadedAvatarUrl = await this.uploadAvatar(this.data.avatarUrl)
  }
  
  // 获取 openid
  const app = getApp()
  const code = await app.getWxLoginCode()
  const openid = await app.getOpenIdFromBackend(code)
  
  // 保存用户信息
  const userInfo = {
    nickName: formNickname.trim(),
    avatarUrl: uploadedAvatarUrl,
    openid: openid
  }
  await app.saveUserToBackend(userInfo)
  
  // 登录成功
  wx.showToast({ title: '登录成功', icon: 'success' })
  wx.navigateBack()
}
```

#### 上传头像到服务器
```javascript
uploadAvatar(tempFilePath) {
  return new Promise((resolve, reject) => {
    const app = getApp()
    
    wx.uploadFile({
      url: app.globalData.baseUrl + 'admin/upload/avatar',
      filePath: tempFilePath,
      name: 'file',
      header: {
        'Content-Type': 'multipart/form-data'
      },
      success: (res) => {
        const data = JSON.parse(res.data)
        if (data.code === 200) {
          resolve(data.data) // 返回服务器URL
        } else {
          resolve(tempFilePath) // 失败使用临时路径
        }
      },
      fail: (err) => {
        resolve(tempFilePath) // 失败使用临时路径
      }
    })
  })
}
```

## 登录流程

### 完整流程图
```
1. 用户触发登录
   ↓
2. 跳转到登录页面
   ↓
3. 点击头像选择器
   ↓
4. 微信弹出头像选择界面
   ↓
5. 用户选择头像
   ↓
6. 微信安全检测头像
   ↓
7. 检测通过，返回临时路径
   ↓
8. 显示选中的头像
   ↓
9. 用户输入昵称
   ↓
10. 失焦时微信检测昵称安全
    ↓
11. 用户点击"登录"按钮
    ↓
12. 表单提交
    ↓
13. 上传头像到服务器
    ↓
14. 获取微信 code
    ↓
15. 调用后端获取 openid
    ↓
16. 调用后端保存用户信息
    ↓
17. 登录成功，返回上一页
```

### 安全检测机制

#### 头像安全检测
- **时机**：用户选择头像后
- **检测方**：微信官方
- **未通过**：不触发 `bindchooseavatar` 回调
- **影响**：用户无法选择不安全的头像

#### 昵称安全检测
- **时机**：input 失焦时
- **检测方**：微信官方（异步）
- **未通过**：微信自动清空 input 内容
- **建议**：通过 form 提交获取最终值

## 后端接口

### 1. 上传头像
```
POST /admin/upload/avatar
Content-Type: multipart/form-data

请求参数:
- file: 头像文件

响应:
{
  "code": 200,
  "msg": "成功",
  "data": "https://服务器域名/头像路径.jpg"
}
```

### 2. 获取 openid
```
POST /admin/getOpenId
Content-Type: application/json

请求体:
{
  "code": "微信登录code"
}

响应:
{
  "code": 200,
  "msg": "成功",
  "data": "openid字符串"
}
```

### 3. 注册/保存用户信息
```
POST /admin/register
Content-Type: application/json

请求体:
{
  "userName": "用户昵称",
  "avatarUrl": "头像URL",
  "openid": "用户openid"
}

响应:
{
  "code": 200,
  "msg": "成功",
  "data": {
    "userId": 用户ID
  }
}
```

## 页面结构

### 登录页面布局
```
┌─────────────────────────────────┐
│         Logo + 标题              │
│      "欢迎登录"                   │
├─────────────────────────────────┤
│                                  │
│   ┌─────────────────────┐       │
│   │   选择头像           │       │
│   │  ┌──────────┐       │       │
│   │  │          │       │       │
│   │  │  头像预览 │       │       │
│   │  │          │       │       │
│   │  └──────────┘       │       │
│   └─────────────────────┘       │
│                                  │
│   ┌─────────────────────┐       │
│   │   输入昵称           │       │
│   │  [____________]  0/20│       │
│   └─────────────────────┘       │
│                                  │
│   ┌─────────────────────┐       │
│   │   ✓ 预览             │       │
│   │  [头像] 昵称         │       │
│   └─────────────────────┘       │
│                                  │
│   [      登录按钮      ]        │
│   [      取消按钮      ]        │
│                                  │
│   · 隐私说明文字                │
└─────────────────────────────────┘
```

## UI 设计特点

### 1. 头像选择器
- 📷 大尺寸预览（280rpx 高度）
- 🎨 未选择时显示提示图标
- 🔄 选择后可点击更换
- ✨ 点击时显示"更换"文字

### 2. 昵称输入框
- ⌨️ 使用微信昵称键盘
- 📊 显示字数统计（0/20）
- 🔍 自动安全检测
- 💡 清晰的占位提示

### 3. 用户预览卡片
- 👁️ 实时预览效果
- ✅ 绿色勾选图标
- 📱 卡片式设计
- 🎯 确认前最后检查

### 4. 操作按钮
- 🔘 登录按钮（白色高亮）
- ❌ 取消按钮（透明边框）
- 🔒 禁用状态提示
- ⏳ 加载状态反馈

## 使用示例

### 在其他页面触发登录
```javascript
// 任意页面
someFunction() {
  const app = getApp()
  
  // 检查登录状态
  app.checkLoginAndShow(() => {
    // 已登录或登录成功后执行
    console.log('用户已登录')
    this.doSomething()
  }, () => {
    // 用户取消登录
    console.log('用户取消登录')
  })
}
```

## 注意事项

### 1. 基础库版本
- ⚠️ `chooseAvatar` 需要基础库 2.21.2+
- ⚠️ `type="nickname"` 需要基础库 2.21.2+
- ⚠️ 安全检测功能需要基础库 2.24.4+

### 2. 头像处理
- 💡 选择的头像是**临时路径**
- 💡 需要上传到**服务器**保存
- 💡 临时路径有效期很短（通常几天）
- 💡 建议立即上传或转存

### 3. 昵称处理
- 💡 使用 `form` 提交获取最终值
- 💡 失焦时会自动安全检测
- 💡 检测不通过会自动清空
- 💡 建议限制长度（如 20 字符）

### 4. 安全检测
- ⚠️ 头像检测不通过：不触发回调
- ⚠️ 昵称检测不通过：自动清空内容
- ⚠️ 检测是**异步**的
- ⚠️ 用户可能感知不到检测过程

### 5. 错误处理
```javascript
// 头像上传失败
if (uploadFailed) {
  // 可以使用临时路径作为备选
  // 或提示用户重新选择
}

// 昵称为空
if (!nickname) {
  wx.showToast({ title: '请输入昵称' })
}
```

## 优势对比

| 功能 | 旧方式 (getUserProfile) | 新方式 (chooseAvatar + nickname) |
|------|------------------------|----------------------------------|
| 用户体验 | ❌ 每次都弹窗 | ✅ 流畅自然 |
| 头像来源 | ❌ 只能用微信头像 | ✅ 可选任意头像 |
| 昵称来源 | ❌ 只能用微信昵称 | ✅ 可自定义昵称 |
| 安全检测 | ❌ 无 | ✅ 自动检测 |
| 官方推荐 | ⚠️ 逐步废弃 | ✅ 官方推荐 |
| 灵活性 | ❌ 低 | ✅ 高 |

## 测试清单

### 功能测试
- [ ] 点击头像选择器弹出相册
- [ ] 选择头像后正确显示
- [ ] 选择不安全头像不触发回调
- [ ] 输入昵称正常显示
- [ ] 输入不安全昵称被清空
- [ ] 用户预览卡片正确显示
- [ ] 登录按钮状态正确
- [ ] 点击登录成功完成流程
- [ ] 头像成功上传到服务器

### 异常测试
- [ ] 未选择头像点击登录 → 提示
- [ ] 未输入昵称点击登录 → 提示
- [ ] 头像上传失败 → 容错处理
- [ ] 网络错误 → 友好提示
- [ ] 取消登录 → 返回上一页

## 文件清单

### 核心文件
- ✅ `pages/login/index.wxml` - 登录页面视图
- ✅ `pages/login/index.js` - 登录页面逻辑
- ✅ `pages/login/index.wxss` - 登录页面样式
- ✅ `pages/login/index.json` - 登录页面配置
- ✅ `app.js` - 全局登录方法

### 后端接口
- ✅ `POST /admin/upload/avatar` - 上传头像
- ✅ `POST /admin/getOpenId` - 获取openid
- ✅ `POST /admin/register` - 注册用户

## 更新日志

**2024-10-12 v3.0**
- ✅ 使用微信官方最新推荐方式
- ✅ 头像选择：`open-type="chooseAvatar"`
- ✅ 昵称输入：`type="nickname"`
- ✅ 表单提交：使用 form 收集数据
- ✅ 自动安全检测
- ✅ 优化用户体验
- ✅ 完善错误处理

---

**创建时间**: 2024年10月12日  
**文档版本**: v3.0  
**更新说明**: 采用微信官方最新推荐的 chooseAvatar + nickname 方式

