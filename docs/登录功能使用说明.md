# 登录功能使用说明

## 概述

本项目实现了完整的微信小程序登录验证流程，包括：
- 使用微信官方 `getUserProfile` 获取用户头像和昵称
- 自动获取 openid
- 在需要登录的功能前进行验证
- 统一的登录弹窗提示

## 功能特点

### 1. 自动化登录流程
```
用户操作 → 检查登录状态 → 未登录弹窗 → 获取头像昵称 → 获取openid → 保存到后端 → 完成登录
```

### 2. 登录触发场景
- ✅ 查看购物车
- ✅ 加入购物车
- ✅ 访问个人中心功能（地址管理等）
- ✅ 点击个人中心头像/昵称区域

### 3. 登录状态管理
- 全局状态：`app.globalData.openid` 和 `app.globalData.userInfo`
- 本地缓存：`wx.getStorageSync('openid')` 和 `wx.getStorageSync('userInfo')`
- 监听机制：支持多个页面监听登录状态变化

## 核心API方法

### App.js 中的方法

#### 1. getUserCompleteInfo()
获取用户完整信息（头像、昵称、openid）

```javascript
const app = getApp()
const userInfo = await app.getUserCompleteInfo()
// userInfo 包含：nickName, avatarUrl, openid 等
```

#### 2. checkUserAuth()
检查用户是否已登录

```javascript
const app = getApp()
const isLogin = app.checkUserAuth()
if (isLogin) {
  // 已登录
} else {
  // 未登录
}
```

#### 3. showLoginDialog(successCallback, cancelCallback)
显示登录弹窗

```javascript
const app = getApp()
app.showLoginDialog(() => {
  // 登录成功回调
  console.log('登录成功')
}, () => {
  // 取消登录回调
  console.log('用户取消登录')
})
```

#### 4. checkLoginAndShow(successCallback, cancelCallback)
检查登录状态，未登录则显示弹窗

```javascript
const app = getApp()
app.checkLoginAndShow(() => {
  // 已登录或登录成功后执行
  // 执行需要登录的操作
}, () => {
  // 用户取消登录
})
```

#### 5. addLoginListener(listener)
添加登录状态监听器

```javascript
const app = getApp()
app.addLoginListener((userInfo) => {
  console.log('登录状态变化:', userInfo)
  // 更新页面数据
})
```

## 页面实现

### 1. 个人中心页面 (pages/mine/index.js)

#### 功能
- 显示用户头像和昵称
- 未登录显示"立即登录"和"点击登录"提示
- 点击头像/昵称区域触发登录
- 已登录显示退出登录按钮
- 访问地址管理等功能需要登录验证

#### 关键代码
```javascript
/**
 * 加载用户信息
 */
loadUserInfo() {
  const app = getApp()
  const isLogin = app.checkUserAuth()
  
  if (isLogin) {
    const userInfo = wx.getStorageSync('userInfo')
    this.setData({
      nickName: userInfo.nickName,
      avatarUrl: userInfo.avatarUrl,
      isLogin: true
    })
  } else {
    this.setData({
      nickName: '立即登录',
      avatarUrl: '/assets/imgs/mine/morentouxiang.png',
      isLogin: false
    })
  }
}

/**
 * 点击头像/昵称登录
 */
handleLogin() {
  if (this.data.isLogin) return
  
  const app = getApp()
  app.showLoginDialog(() => {
    this.loadUserInfo()
  })
}

/**
 * 跳转到地址管理（需要登录）
 */
goToAddressManage() {
  const app = getApp()
  app.checkLoginAndShow(() => {
    wx.navigateTo({
      url: '/pages/address/index'
    })
  })
}
```

### 2. 购物车页面 (pages/cart/index.js)

#### 功能
- 进入页面时检查登录状态
- 未登录显示登录弹窗
- 取消登录返回上一页

#### 关键代码
```javascript
onLoad(options) {
  const app = getApp()
  if (!app.checkUserAuth()) {
    // 未登录，显示登录弹窗
    app.showLoginDialog(() => {
      // 登录成功后加载购物车
      this.loadCartData()
    }, () => {
      // 取消登录，返回上一页
      wx.navigateBack()
    })
  } else {
    this.loadCartData()
  }
}
```

### 3. 首页加购功能 (pages/home/index.js)

#### 功能
- 点击加入购物车前检查登录状态
- 未登录显示登录弹窗
- 登录成功后自动执行加购操作

#### 关键代码
```javascript
/**
 * 添加到购物车
 */
async addToCart(e) {
  const book = e.currentTarget.dataset.book
  
  // 检查登录状态
  const app = getApp()
  if (!app.checkUserAuth()) {
    // 未登录，显示登录弹窗
    app.showLoginDialog(async () => {
      // 登录成功后执行加入购物车
      await this.doAddToCart(book)
    })
    return
  }
  
  // 已登录，直接加入购物车
  await this.doAddToCart(book)
}

/**
 * 执行加入购物车操作
 */
async doAddToCart(book) {
  try {
    const openid = await this.getOpenId()
    const res = await API.cart.addToCart({
      openid: openid,
      bookId: book.id,
      quantity: 1
    })
    
    if (res.data && res.data.code === 200) {
      this.showToast('已添加到购物车')
    }
  } catch (error) {
    console.error('添加购物车失败:', error)
  }
}
```

### 4. 分类页面加购功能 (pages/categoryBrand/index.js)

与首页加购功能相同，添加了登录检查。

## 登录流程详解

### 1. 用户触发登录

```
用户点击"加入购物车"
    ↓
检查 app.checkUserAuth()
    ↓
返回 false（未登录）
    ↓
显示登录弹窗
```

### 2. 用户确认登录

```
用户点击"去登录"
    ↓
调用 app.getUserCompleteInfo()
    ↓
调用 wx.getUserProfile() 获取头像昵称
    ↓
调用 wx.login() 获取 code
    ↓
调用后端接口获取 openid
    ↓
组合完整用户信息
```

### 3. 保存用户信息

```
调用 app.saveUserToBackend()
    ↓
保存到后端数据库
    ↓
保存到本地缓存
    ↓
保存到全局变量
    ↓
通知所有监听器
    ↓
执行成功回调
```

### 4. 执行原操作

```
登录成功
    ↓
执行 successCallback
    ↓
执行加入购物车等操作
```

## 数据存储

### 本地缓存
```javascript
// 用户信息
{
  nickName: '微信用户',
  avatarUrl: 'https://...',
  openid: 'xxxxxx',
  userId: 123456
}

// openid
'xxxxxxxxxxxxxx'
```

### 全局变量
```javascript
app.globalData = {
  userInfo: { ... },
  openid: 'xxxxxx'
}
```

## 退出登录

### 个人中心退出
```javascript
/**
 * 退出登录
 */
loginOut() {
  // 清除本地缓存
  wx.removeStorageSync('userInfo')
  wx.removeStorageSync('openid')
  
  // 清除全局数据
  const app = getApp()
  app.globalData.userInfo = null
  app.globalData.openid = null
  
  // 重新设置默认状态
  this.setData({
    nickName: '立即登录',
    avatarUrl: '/assets/imgs/mine/morentouxiang.png',
    isLogin: false
  })
  
  wx.showToast({
    title: '已退出登录',
    icon: 'success'
  })
}
```

## 后端接口

### 1. 获取openid
```
POST /user/getOpenId
Content-Type: application/json

请求体: "code码"

响应:
{
  "code": 200,
  "msg": "成功",
  "data": "openid字符串"
}
```

### 2. 注册/保存用户信息
```
POST /user/register
Content-Type: application/json

请求体:
{
  "userName": "微信用户",
  "avatarUrl": "https://...",
  "openid": "xxxxxx"
}

响应:
{
  "code": 200,
  "msg": "成功",
  "data": {
    "userId": 123456
  }
}
```

## 使用示例

### 示例1：在任意页面添加登录检查

```javascript
// 页面的某个功能需要登录
someFunction() {
  const app = getApp()
  app.checkLoginAndShow(() => {
    // 用户已登录或登录成功，执行功能
    this.doSomething()
  }, () => {
    // 用户取消登录
    wx.showToast({
      title: '需要登录才能使用',
      icon: 'none'
    })
  })
}
```

### 示例2：监听登录状态变化

```javascript
Page({
  onLoad() {
    // 添加登录监听
    const app = getApp()
    app.addLoginListener(this.onLoginChange.bind(this))
  },
  
  onUnload() {
    // 移除登录监听
    const app = getApp()
    app.removeLoginListener(this.onLoginChange.bind(this))
  },
  
  onLoginChange(userInfo) {
    console.log('登录状态变化:', userInfo)
    // 刷新页面数据
    this.loadData()
  }
})
```

## 注意事项

1. **getUserProfile 需要用户主动触发**
   - 必须在用户点击按钮等操作后调用
   - 不能在页面加载时自动调用

2. **登录弹窗时机**
   - 在用户需要使用功能时弹出，而不是一进入页面就弹
   - 提供取消选项，不要强制登录

3. **数据同步**
   - 登录成功后通知所有监听的页面
   - 退出登录时清除所有相关数据

4. **错误处理**
   - 登录失败时给予明确提示
   - 网络错误时进行本地容错处理

5. **用户体验**
   - 登录流程简单明了
   - 提供清晰的状态反馈
   - 取消登录不影响其他功能使用

## 已完成功能清单

- ✅ 完整的登录流程（头像、昵称、openid）
- ✅ 个人中心登录入口
- ✅ 购物车登录验证
- ✅ 加入购物车登录验证
- ✅ 地址管理登录验证
- ✅ 退出登录功能
- ✅ 登录状态监听机制
- ✅ 统一的登录弹窗
- ✅ 自动保存到后端

## 测试建议

### 功能测试
1. 未登录状态访问购物车 → 应弹出登录提示
2. 未登录状态加入购物车 → 应弹出登录提示
3. 个人中心点击头像/昵称 → 触发登录
4. 登录成功后 → 显示用户信息
5. 退出登录 → 清除用户信息
6. 登录后加购 → 成功添加到购物车

### 场景测试
1. 取消登录弹窗 → 不影响其他操作
2. 登录失败 → 提示重试
3. 网络错误 → 容错处理
4. 多页面同步 → 登录状态一致

---

**创建时间**: 2024年10月12日  
**文档版本**: v1.0

